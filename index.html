<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Purchase Pro v7.1</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary: #2563eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --bg: #f8fafc; --card: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--text-main); overflow-x: hidden; }

        /* HEADER */
        .header { background: var(--primary); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .header h1 { font-size: 1.1rem; margin: 0; font-weight: 700; flex-grow: 1; text-align: center; }

        /* SIDEBAR */
        .sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--card); z-index: 100; transition: 0.3s ease; box-shadow: 10px 0 20px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box; }
        .sidebar.active { left: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 90; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 12px; cursor: pointer; margin-bottom: 5px; color: var(--text-main); font-weight: 600; }
        .menu-item.active { background: #eff6ff; color: var(--primary); }

        /* SE√á√ïES */
        .view-section { display: none; padding: 15px; max-width: 600px; margin: auto; }
        .view-section.active { display: block; }

        /* CARDS */
        .card { background: var(--card); padding: 18px; border-radius: 18px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 110px; display: flex; flex-direction: column; }
        input, select { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        label { font-size: 0.7rem; font-weight: 700; color: var(--text-sub); margin-bottom: 4px; text-transform: uppercase; }

        /* BOTOES */
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; border-radius: 12px; padding: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-secondary { background: #f1f5f9; color: var(--text-main); border: none; border-radius: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; }

        /* LISTA DE COMPRAS */
        .item-card { background: white; padding: 12px 15px; border-radius: 14px; margin-bottom: 8px; border: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .item-card.hidden { display: none; }
        .price-tag { color: var(--success); font-weight: 700; }

        /* LISTA DE FALTAS (NOVO ESTILO) */
        .falta-item { display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px 15px; border-radius: 14px; margin-bottom: 8px; border: 1px solid #f1f5f9; transition: 0.2s; }
        .falta-content { display: flex; align-items: center; gap: 10px; flex-grow: 1; cursor: pointer; }
        .falta-text { font-weight: 600; transition: 0.2s; }
        .falta-item.no-carrinho { background: #f8fafc; opacity: 0.6; }
        .falta-item.no-carrinho .falta-text { text-decoration: line-through; color: var(--text-sub); }
        .check-icon { color: #cbd5e1; }
        .falta-item.no-carrinho .check-icon { color: var(--success); }

        #btnExpandir { width: 100%; padding: 12px; background: none; border: 1px dashed var(--text-sub); color: var(--text-sub); border-radius: 10px; margin-bottom: 20px; font-weight: 600; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="overlay"></div>
<div class="sidebar" id="sidebar">
    <h2 style="color: var(--primary); font-size: 1.2rem;">Menu</h2>
    <div class="menu-item active" id="m-compras" onclick="switchView('compras')"><span class="material-icons">shopping_cart</span> Registro de Compras</div>
    <div class="menu-item" id="m-faltas" onclick="switchView('faltas')"><span class="material-icons">fact_check</span> Checklist de Mercado</div>
    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
    <div class="menu-item" onclick="exportarCSV()"><span class="material-icons">download</span> Exportar CSV</div>
    <button onclick="toggleSidebar()" class="btn-main" style="background: #f1f5f9; color: var(--text-main); margin-top: 20px;">Fechar</button>
</div>

<div class="header">
    <div onclick="toggleSidebar()"><span class="material-icons">menu</span></div>
    <h1 id="view-title">Smart Purchase</h1>
    <div onclick="location.reload(true)"><span class="material-icons">refresh</span></div>
</div>

<div id="view-compras" class="view-section active">
    <div class="card">
        <form id="addCompraForm">
            <input type="hidden" id="edit-timestamp">
            <label>Produto</label>
            <input type="text" id="produto" required placeholder="Nome do item">
            <div class="form-row" style="margin-top:10px">
                <div class="form-group"><label>Qtd</label><input type="number" id="qtd" value="1" step="0.01"></div>
                <div class="form-group"><label>Unid</label><select id="unidade"><option value="un">un</option><option value="kg">kg</option><option value="g">g</option><option value="L">L</option><option value="ml">ml</option></select></div>
                <div class="form-group"><label>Pre√ßo Unit.</label><input type="number" id="precoUnit" step="0.01" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>GTIN</label><input type="text" id="gtin"></div>
                <div class="form-group"><label>Local</label><select id="localSelect"></select></div>
            </div>
            <button type="submit" id="mainButton" class="btn-main">Salvar na Planilha</button>
        </form>
    </div>
    <div class="list-container" id="listaCompras"></div>
    <button id="btnExpandir" onclick="toggleExpandir()">Ver Hist√≥rico Completo</button>
</div>

<div id="view-faltas" class="view-section">
    <div class="card">
        <label>O que est√° faltando em casa?</label>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <input type="text" id="itemFalta" placeholder="Ex: Arroz" style="flex-grow: 1;">
            <button onclick="addFalta()" class="btn-main" style="width: auto; padding: 0 20px;"><span class="material-icons">add</span></button>
        </div>
    </div>
    <h3 style="font-size: 0.9rem; color: var(--text-sub); margin-bottom: 10px;">Toque no item para marcar como "No Carrinho"</h3>
    <div id="listaFaltasContainer"></div>
</div>

<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzVXCbI9Ihl3C9Yr-Jy8aowZXcfx3dSpAbQ1P8rUrPkOwSKjhnTlcTTPId7R1FYhpbRJQ/exec'; 
    let compras = [];
    let faltas = JSON.parse(localStorage.getItem('faltas') || '[]');
    let isEditing = false;
    let listaExpandida = false;

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    document.getElementById('overlay').onclick = toggleSidebar;

    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        document.getElementById('m-' + view).classList.add('active');
        document.getElementById('view-title').textContent = view === 'compras' ? 'Smart Purchase' : 'Checklist de Mercado';
        if(window.innerWidth < 768) toggleSidebar();
        if(view === 'faltas') renderFaltas();
    }

    async function carregarTudo() {
        const [resD, resL] = await Promise.all([ fetch(`${WEB_APP_URL}?action=read`), fetch(`${WEB_APP_URL}?action=getLocais`) ]);
        compras = (await resD.json()).data;
        document.getElementById('localSelect').innerHTML = (await resL.json()).data.map(l => `<option value="${l}">${l}</option>`).join('');
        renderCompras();
    }

    function renderCompras() {
        const container = document.getElementById('listaCompras');
        container.innerHTML = compras.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map((c, index) => {
            const hiddenClass = (!listaExpandida && index >= 5) ? 'hidden' : '';
            return `<div class="item-card ${hiddenClass}">
                <div><b>${c.produto} <small>${c.qtd}${c.unidade}</small></b><span class="price-tag">R$ ${parseFloat(c.preco).toFixed(2)}</span></div>
                <span class="material-icons" style="color:var(--text-sub)" onclick="prepararEdicao('${c.timestamp}')">edit</span>
            </div>`;
        }).join('');
        document.getElementById('btnExpandir').style.display = compras.length > 5 ? "block" : "none";
    }

    function toggleExpandir() { listaExpandida = !listaExpandida; renderCompras(); }

    // --- L√ìGICA DE FALTAS (CHECKLIST) ---
    function addFalta() {
        const input = document.getElementById('itemFalta');
        if(!input.value) return;
        faltas.push({ id: Date.now(), produto: input.value, noCarrinho: false });
        input.value = "";
        salvarFaltas();
    }

    function toggleCarrinho(id) {
        const index = faltas.findIndex(f => f.id === id);
        faltas[index].noCarrinho = !faltas[index].noCarrinho;
        salvarFaltas();
    }

    function salvarFaltas() {
        localStorage.setItem('faltas', JSON.stringify(faltas));
        renderFaltas();
    }

    function renderFaltas() {
        const container = document.getElementById('listaFaltasContainer');
        // Ordena para que os riscados fiquem por √∫ltimo
        const ordenadas = [...faltas].sort((a, b) => a.noCarrinho - b.noCarrinho);
        
        container.innerHTML = ordenadas.map(f => `
            <div class="falta-item ${f.noCarrinho ? 'no-carrinho' : ''}">
                <div class="falta-content" onclick="toggleCarrinho(${f.id})">
                    <span class="material-icons check-icon">${f.noCarrinho ? 'check_circle' : 'radio_button_unchecked'}</span>
                    <span class="falta-text">${f.produto}</span>
                </div>
                <div style="display:flex; gap:12px;">
                    <button class="btn-secondary" style="background:#eff6ff; color:var(--primary); padding:5px 10px;" onclick="marcarComoComprado('${f.produto}', ${f.id})">üõí REGISTRAR</button>
                    <span class="material-icons" style="color:var(--danger); cursor:pointer;" onclick="removerFalta(${f.id})">delete</span>
                </div>
            </div>
        `).join('');
    }

    function marcarComoComprado(nome, id) {
        switchView('compras');
        document.getElementById('produto').value = nome;
        removerFalta(id);
        window.scrollTo(0,0);
    }

    function removerFalta(id) {
        faltas = faltas.filter(f => f.id !== id);
        salvarFaltas();
    }

    document.getElementById('addCompraForm').onsubmit = async (e) => {
        e.preventDefault();
        const pUnit = parseFloat(document.getElementById('precoUnit').value);
        const qtd = parseFloat(document.getElementById('qtd').value);
        const dados = {
            data: new Date().toISOString().split('T')[0],
            produto: document.getElementById('produto').value,
            qtd: qtd, unidade: document.getElementById('unidade').value,
            preco: pUnit * qtd, gtin: document.getElementById('gtin').value || "S/G",
            local: document.getElementById('localSelect').value
        };
        await fetch(`${WEB_APP_URL}?action=write&data=${encodeURIComponent(JSON.stringify(dados))}`);
        document.getElementById('addCompraForm').reset();
        carregarTudo();
    };

    function exportarCSV() { /* ... mant√©m fun√ß√£o anterior ... */ }

    carregarTudo();
</script>
</body>
</html>
