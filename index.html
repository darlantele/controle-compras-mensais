<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Compras Mensais</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #0056b3;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        #scanButton {
            background-color: #007bff;
        }
        #scanButton:hover {
            background-color: #0056b3;
        }
        #exportButton {
            background-color: #6c757d;
        }
        #exportButton:hover {
            background-color: #5a6268;
        }
        #filterSection {
            background-color: #e0f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        #filterSection input {
            width: auto;
            margin-right: 10px;
        }
        .filter-controls {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        #historico {
            margin-top: 30px;
        }
        #listaCompras {
            list-style: none;
            padding: 0;
        }
        #listaCompras li {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .total {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            color: #dc3545;
        }
        /* Modal para o Leitor de C√≥digo de Barras */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #reader {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Controle de Compras Mensais</h1>

    <div id="filterSection">
        <h2>üìä An√°lise por Per√≠odo</h2>
        <div class="filter-controls">
            <div class="form-group">
                <label for="startDateFilter">De:</label>
                <input type="date" id="startDateFilter">
            </div>
            <div class="form-group">
                <label for="endDateFilter">At√©:</label>
                <input type="date" id="endDateFilter">
            </div>
            <button type="button" id="filterButton">Filtrar</button>
            <button type="button" id="resetFilterButton" style="background-color: #ffc107; color: #333;">Limpar Filtro</button>
        </div>
    </div>
    
    <hr>

    <h2>Adicionar Nova Compra</h2>
    <form id="addCompraForm">
        <div class="form-group">
            <label for="produto">Produto (ou GTIN do escaneamento):</label>
            <input type="text" id="produto" required>
        </div>
        <div class="form-group">
            <label for="gtin">C√≥digo de Barras (GTIN):</label>
            <input type="text" id="gtin" placeholder="Ser√° preenchido pelo escaneamento ou digitado">
        </div>
        <div class="form-group">
            <label for="preco">Pre√ßo (R$):</label>
            <input type="number" id="preco" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="local">Local da Compra:</label>
            <input type="text" id="local" placeholder="Ex: Supermercado X">
        </div>
        <div class="form-group">
            <label for="dataCompra">Data:</label>
            <input type="date" id="dataCompra" required>
        </div>
        
        <button type="submit" id="addCompraButton">Adicionar Compra</button>
        <button type="button" id="scanButton">Escanear C√≥digo de Barras</button>
        <button type="button" id="exportButton">Exportar CSV</button>
    </form>
    
    <hr>

    <div id="historico">
        <h2>Hist√≥rico de Compras</h2>
        <p class="total">Total Gasto no Per√≠odo: <span id="totalGasto">R$ 0,00</span></p>
        <ul id="listaCompras">
            </ul>
    </div>
</div>

<div id="barcodeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Escaneamento de C√≥digo de Barras</h2>
        <div id="reader"></div>
        <p id="scanResult"></p>
    </div>
</div>

<script>
    // ** MUITO IMPORTANTE: SUBSTITUA ESTE PLACEHOLDER PELA SUA URL DO APPS SCRIPT **
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzVXCbI9Ihl3C9Yr-Jy8aowZXcfx3dSpAbQ1P8rUrPkOwSKjhnTlcTTPId7R1FYhpbRJQ/exec'; 
    // ** A URL deve ser uma string, entre aspas simples ('') **

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('addCompraForm');
        const listaCompras = document.getElementById('listaCompras');
        const totalGastoSpan = document.getElementById('totalGasto');
        const scanButton = document.getElementById('scanButton');
        const exportButton = document.getElementById('exportButton');
        const filterButton = document.getElementById('filterButton');
        const resetFilterButton = document.getElementById('resetFilterButton');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const barcodeModal = document.getElementById('barcodeModal');
        const closeSpan = document.querySelector('.close');
        const produtoInput = document.getElementById('produto');
        const gtinInput = document.getElementById('gtin');
        const precoInput = document.getElementById('preco');
        const localInput = document.getElementById('local');
        const dataCompraInput = document.getElementById('dataCompra');

        // MUDAN√áA: O array 'compras' agora √© um cache local, mas a fonte prim√°ria √© a nuvem
        let compras = []; // Come√ßa vazio, os dados vir√£o da nuvem

        let html5QrcodeScanner;

        // Mock data (dados simulados para demonstra√ß√£o)
        const mockCatalog = {
            "7891000123456": { nome: "Biscoito Recheado Choco. Marca X 130g", preco: 3.50, local: "Supermercado A" },
            "7892000678901": { nome: "Arroz Agulhinha Tipo 1, 5kg", preco: 25.90, local: "Atacado Y" },
            "7893000246802": { nome: "Leite Integral UHT 1L", preco: 4.99, local: "Mercado Z" }
        };

        // ------------------ FUN√á√ÉO CENTRAL: SALVAR NA NUVEM ------------------

        const salvarNaNuvem = async (dados) => {
            document.getElementById('addCompraButton').disabled = true;
            document.getElementById('addCompraButton').textContent = 'Salvando...';

            try {
                // Requisi√ß√£o POST para o Apps Script
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // Necess√°rio para evitar erros de CORS (Cross-Origin Resource Sharing)
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8' 
                        // Apps Script prefere 'text/plain' para o corpo raw/JSON
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();

                if (resultado.status === 'success') {
                    alert('‚úÖ Compra salva na nuvem com sucesso!');
                    // Ap√≥s salvar, atualizamos o hist√≥rico
                    await buscarDadosDaNuvem(); 
                } else {
                    alert('‚ùå Erro ao salvar na nuvem: ' + resultado.message);
                }
            } catch (error) {
                alert('üö® Erro de conex√£o com o servidor: ' + error.message);
            } finally {
                document.getElementById('addCompraButton').disabled = false;
                document.getElementById('addCompraButton').textContent = 'Adicionar Compra';
            }
        };

        // ------------------ FUN√á√ÉO CENTRAL: BUSCAR NA NUVEM ------------------

        const buscarDadosDaNuvem = async () => {
            // Se o App Script tiver uma fun√ß√£o para ler dados, usaremos um GET aqui.
            // Para simplicidade inicial, voc√™ importar√° o CSV da planilha para an√°lise.
            
            // POR ENQUANTO, para a demonstra√ß√£o e para manter a experi√™ncia do usu√°rio,
            // carregaremos um array VAZIO, j√° que n√£o implementamos a fun√ß√£o de LEITURA no Apps Script.
            // A leitura √© mais complexa e faremos em uma etapa posterior.
            // A prioridade agora √© garantir a ESCRITA na nuvem.
            compras = []; 

            // Para que o filtro funcione, precisamos da fun√ß√£o de leitura da nuvem. 
            // POR ENQUANTO, manteremos uma vers√£o de LEITURA DO LOCAL STORAGE (LEGADO)
            // APENAS PARA O TESTE E FILTRAGEM. Isso ser√° removido na pr√≥xima etapa.
            compras = JSON.parse(localStorage.getItem('comprasMensais')) || [];

            aplicarFiltro();
        };
        
        // ------------------ Renderiza√ß√£o e Remo√ß√£o (Inalteradas, usam o array 'compras') ------------------
        
        const renderCompras = (comprasParaRenderizar = compras) => {
            listaCompras.innerHTML = '';
            let total = 0;
            
            // Ordena por data decrescente (mais recente primeiro)
            comprasParaRenderizar.sort((a, b) => new Date(b.data) - new Date(a.data));

            comprasParaRenderizar.forEach((compra, index) => {
                total += parseFloat(compra.preco);
                const li = document.createElement('li');
                li.innerHTML = `
                    **${compra.produto}** (${compra.gtin || 'Sem GTIN'}) | R$ ${compra.preco.toFixed(2)} | ${compra.local} | ${compra.data}
                    <button onclick="removerCompra('${compra.data}', '${compra.gtin}', ${compra.preco})">Remover</button>
                `;
                listaCompras.appendChild(li);
            });

            totalGastoSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            // MUDAN√áA: N√£o salva no Local Storage aqui. Apenas atualiza o cache de visualiza√ß√£o.
        };

        // Fun√ß√£o global para remover item - IMPORTANTE: A remo√ß√£o AGORA PRECISA OCORRER NA NUVEM
        window.removerCompra = (data, gtin, preco) => {
            // ATEN√á√ÉO: A remo√ß√£o na nuvem (Sheets) √© mais complexa. Por enquanto,
            // para manter o foco na ESCRITA, o bot√£o de remover far√° a remo√ß√£o APENAS no Local Storage 
            // e no array de visualiza√ß√£o 'compras', mas N√ÉO ser√° sincronizado com o Sheets.
            
            // Para remo√ß√£o no Sheets, precisar√≠amos de uma fun√ß√£o DELETE no Apps Script, 
            // que √© a pr√≥xima etapa de complexidade. Por enquanto:
            alert("‚ö†Ô∏è Fun√ß√£o de remo√ß√£o na Nuvem n√£o implementada. Removendo apenas do hist√≥rico local.");

            // Remove do cache de visualiza√ß√£o (e Local Storage temporariamente)
             const originalIndex = compras.findIndex(c => 
                c.data === data && 
                c.gtin === gtin && 
                c.preco === preco
            );

            if (originalIndex > -1) {
                 compras.splice(originalIndex, 1);
            }
            
            // Salva no Local Storage (LEGADO) para manter a coer√™ncia local at√© implementarmos a Leitura da Nuvem
            localStorage.setItem('comprasMensais', JSON.stringify(compras)); 
            
            aplicarFiltro();
        };

        // Adicionar nova compra (MODIFICADO)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const novaCompra = {
                data: dataCompraInput.value,
                produto: produtoInput.value,
                gtin: gtinInput.value || 'SEM_GTIN',
                preco: parseFloat(precoInput.value),
                local: localInput.value
            };

            // NOVA A√á√ÉO: Chama a fun√ß√£o que salva na nuvem (Apps Script)
            await salvarNaNuvem(novaCompra); 
            
            form.reset();
            dataCompraInput.valueAsDate = new Date();
            // aplicarFiltro() √© chamado dentro de salvarNaNuvem() ap√≥s o sucesso
        });
        
        // ------------------ Fun√ß√µes de Filtro e Exporta√ß√£o (MANTIDAS) ------------------

        const aplicarFiltro = () => {
             // ... [Mantenha o c√≥digo da fun√ß√£o aplicarFiltro (usa o array 'compras')] ...
             const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (!startDate && !endDate) {
                renderCompras(compras); // Sem filtro
                return;
            }

            const dataInicial = startDate ? new Date(startDate + 'T00:00:00') : new Date('1900-01-01T00:00:00');
            const dataFinal = endDate ? new Date(endDate + 'T23:59:59') : new Date('2900-01-01T23:59:59');

            const comprasFiltradas = compras.filter(compra => {
                const dataCompra = new Date(compra.data + 'T00:00:00');
                return dataCompra >= dataInicial && dataCompra <= dataFinal;
            });

            renderCompras(comprasFiltradas);
        };

        filterButton.addEventListener('click', aplicarFiltro);
        
        resetFilterButton.addEventListener('click', () => {
            startDateFilter.value = '';
            endDateFilter.value = '';
            aplicarFiltro();
        });

        const exportarCSV = () => {
             // ... [Mantenha o c√≥digo da fun√ß√£o exportarCSV (usa o array 'compras')] ...
             if (compras.length === 0) {
                alert("N√£o h√° dados de compra para exportar.");
                return;
            }

            // Define os cabe√ßalhos do CSV
            const headers = ["Data", "Produto", "GTIN", "Preco", "Local"];
            let csvContent = headers.join(";") + "\n";

            // Converte os dados para linhas CSV
            compras.forEach(compra => {
                const precoFormatado = compra.preco.toFixed(2).replace('.', ','); // Formata para padr√£o BR (v√≠rgula)
                const row = [
                    compra.data,
                    compra.produto,
                    compra.gtin,
                    precoFormatado,
                    compra.local
                ].join(";");
                csvContent += row + "\n";
            });

            // Cria um link de download
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'compras_mensais_export_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Dados exportados com sucesso! Verifique sua pasta de downloads.");
        };

        exportButton.addEventListener('click', exportarCSV);

        // ------------------ Fun√ß√µes do Leitor de C√≥digo de Barras (MANTIDAS) ------------------
        
        // ... [Mantenha as fun√ß√µes do scanner onScanSuccess, startScanner, e os Eventos do Modal] ...
        
        // Fun√ß√£o de sucesso do scan
        const onScanSuccess = (decodedText, decodedResult) => {
            html5QrcodeScanner.stop().then(() => {
                barcodeModal.style.display = "none";
                
                gtinInput.value = decodedText;
                document.getElementById('scanResult').textContent = `C√≥digo escaneado: ${decodedText}`;

                // Simula√ß√£o da busca de produto
                const produtoSimulado = mockCatalog[decodedText];
                if (produtoSimulado) {
                    produtoInput.value = produtoSimulado.nome;
                    precoInput.value = produtoSimulado.preco;
                    localInput.value = produtoSimulado.local;
                } else {
                    produtoInput.value = `Produto Desconhecido (GTIN: ${decodedText})`;
                    precoInput.value = '';
                    localInput.value = '';
                }

                alert(`C√≥digo de Barras Escaneado: ${decodedText}. Preencha os detalhes e adicione a compra.`);

            }).catch(err => {
                console.error("Erro ao parar o scanner:", err);
            });
        };

        // Fun√ß√£o para iniciar o scanner
        const startScanner = () => {
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } }, 
                onScanSuccess, 
                (errorMessage) => { 
                    // Log de erro silencioso
                    // console.log(`Erro de scanner: ${errorMessage}`);
                }
            ).catch(err => {
                document.getElementById('scanResult').textContent = `Erro ao iniciar a c√¢mera: ${err}. Certifique-se de que o dispositivo tem c√¢mera e deu permiss√£o.`;
            });
        };

        // Eventos do Modal
        scanButton.onclick = function() {
            barcodeModal.style.display = "block";
            document.getElementById('scanResult').textContent = 'Aponte a c√¢mera para o c√≥digo de barras...';
            startScanner();
        }

        closeSpan.onclick = function() {
            barcodeModal.style.display = "none";
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().catch(err => console.error("Erro ao parar o scanner no fechamento:", err));
            }
        }

        window.onclick = function(event) {
            if (event.target == barcodeModal) {
                barcodeModal.style.display = "none";
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.stop().catch(err => console.error("Erro ao parar o scanner no clique externo:", err));
                }
            }
        }
        
        // ------------------ Inicializa√ß√£o ------------------
        dataCompraInput.valueAsDate = new Date();
        // Na inicializa√ß√£o, tentamos buscar os dados da nuvem (ou do Local Storage, temporariamente)
        buscarDadosDaNuvem(); 
    });
</script>

</body>

</html>
