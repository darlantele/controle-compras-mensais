<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Compras Mensais</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            color: #0056b3;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        #scanButton {
            background-color: #007bff;
        }
        #scanButton:hover {
            background-color: #0056b3;
        }
        #exportButton {
            background-color: #6c757d;
        }
        #exportButton:hover {
            background-color: #5a6268;
        }
        #filterSection {
            background-color: #e0f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        #filterSection input {
            width: auto;
            margin-right: 10px;
        }
        .filter-controls {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        #historico {
            margin-top: 30px;
        }
        #listaCompras {
            list-style: none;
            padding: 0;
        }
        #listaCompras li {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .total {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            color: #dc3545;
        }
        /* Modal para o Leitor de C√≥digo de Barras */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #reader {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Controle de Compras Mensais</h1>

    <div id="filterSection">
        <h2>üìä An√°lise por Per√≠odo</h2>
        <div class="filter-controls">
            <div class="form-group">
                <label for="startDateFilter">De:</label>
                <input type="date" id="startDateFilter">
            </div>
            <div class="form-group">
                <label for="endDateFilter">At√©:</label>
                <input type="date" id="endDateFilter">
            </div>
            <button type="button" id="filterButton">Filtrar</button>
            <button type="button" id="resetFilterButton" style="background-color: #ffc107; color: #333;">Limpar Filtro</button>
        </div>
    </div>
    
    <hr>

    <h2>Adicionar Nova Compra</h2>
    <form id="addCompraForm">
        <div class="form-group">
            <label for="produto">Produto (ou GTIN do escaneamento):</label>
            <input type="text" id="produto" required>
        </div>
        <div class="form-group">
            <label for="gtin">C√≥digo de Barras (GTIN):</label>
            <input type="text" id="gtin" placeholder="Ser√° preenchido pelo escaneamento ou digitado">
        </div>
        <div class="form-group">
            <label for="preco">Pre√ßo (R$):</label>
            <input type="number" id="preco" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="localSelect">Local da Compra:</label>
            <select id="localSelect"></select> </div>
        <div class="form-group">
            <label for="dataCompra">Data:</label>
            <input type="date" id="dataCompra" required>
        </div>
        
        <button type="submit" id="addCompraButton">Adicionar Compra</button>
        <button type="button" id="scanButton">Escanear C√≥digo de Barras</button>
        <button type="button" id="limparButton" style="background-color: #dc3545;">Limpar Formul√°rio</button> <button type="button" id="exportButton">Exportar CSV</button>
    </form>
    
    <hr>

    <div id="historico">
        <h2>Hist√≥rico de Compras</h2>
        <p class="total">Total Gasto no Per√≠odo: <span id="totalGasto">R$ 0,00</span></p>
        <ul id="listaCompras">
            </ul>
    </div>
</div>

<div id="barcodeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Escaneamento de C√≥digo de Barras</h2>
        <div id="reader"></div>
        <p id="scanResult"></p>
    </div>
</div>

<script>
    // ** MUITO IMPORTANTE: MANTENHA SUA URL DO APPS SCRIPT AQUI **
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzVXCbI9Ihl3C9Yr-Jy8aowZXcfx3dSpAbQ1P8rUrPkOwSKjhnTlcTTPId7R1FYhpbRJQ/exec'; 
    // ** A URL deve ser uma string, entre aspas simples ('') **

    const LOCAIS_DE_COMPRA = [
        "Supermercado A", 
        "Atacado Y", 
        "Mercado Z", 
        "Padaria Central", 
        "Farm√°cia L√≠der"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('addCompraForm');
        const listaCompras = document.getElementById('listaCompras');
        const totalGastoSpan = document.getElementById('totalGasto');
        const scanButton = document.getElementById('scanButton');
        const exportButton = document.getElementById('exportButton');
        const filterButton = document.getElementById('filterButton');
        const resetFilterButton = document.getElementById('resetFilterButton');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const barcodeModal = document.getElementById('barcodeModal');
        const closeSpan = document.querySelector('.close');
        
        const produtoInput = document.getElementById('produto');
        const gtinInput = document.getElementById('gtin');
        const precoInput = document.getElementById('preco');
        const localSelect = document.getElementById('localSelect');
        const dataCompraInput = document.getElementById('dataCompra');
        const limparButton = document.getElementById('limparButton'); 

        // Adiciona as op√ß√µes de local ao campo SELECT
        LOCAIS_DE_COMPRA.forEach(local => {
            const option = document.createElement('option');
            option.value = local;
            option.textContent = local;
            localSelect.appendChild(option);
        });

        // MUDAN√áA: 'compras' √© o array de dados da nuvem
        let compras = []; 
        let html5QrcodeScanner;

        const mockCatalog = {
            "7891000123456": { nome: "Biscoito Recheado Choco. Marca X 130g", preco: 3.50, local: "Supermercado A" },
            "7892000678901": { nome: "Arroz Agulhinha Tipo 1, 5kg", preco: 25.90, local: "Atacado Y" },
            "7893000246802": { nome: "Leite Integral UHT 1L", preco: 4.99, local: "Mercado Z" }
        };

        const limparFormulario = () => {
            form.reset();
            dataCompraInput.valueAsDate = new Date();
        };
        limparButton.addEventListener('click', limparFormulario);


        // ------------------ FUN√á√ÉO CENTRAL: BUSCAR NA NUVEM (MODIFICADA) ------------------

        const buscarDadosDaNuvem = async () => {
            try {
                // Requisi√ß√£o GET para buscar dados
                const response = await fetch(WEB_APP_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                const resultado = await response.json();

                if (resultado.status === 'success') {
                    // Armazena os dados vindos da planilha no array 'compras'
                    compras = resultado.data; 
                    aplicarFiltro();
                    // Limpa o Local Storage, pois n√£o √© mais a fonte prim√°ria
                    localStorage.removeItem('comprasMensais'); 
                } else {
                    console.error('Erro ao buscar dados:', resultado.message);
                    alert('‚ö†Ô∏è N√£o foi poss√≠vel carregar o hist√≥rico de compras da nuvem.');
                }
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                alert('üö® Falha na comunica√ß√£o com o Google Sheets API. Verifique a conex√£o.');
            }
        };


        // ------------------ FUN√á√ÉO CENTRAL: SALVAR NA NUVEM (Inalterada) ------------------

        const salvarNaNuvem = async (dados) => {
            document.getElementById('addCompraButton').disabled = true;
            document.getElementById('addCompraButton').textContent = 'Salvando...';

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();

                if (resultado.status === 'success') {
                    alert('‚úÖ Compra salva na nuvem com sucesso!');
                    limparFormulario();
                    // Ap√≥s salvar, busca todos os dados novamente para atualizar o hist√≥rico
                    await buscarDadosDaNuvem(); 
                } else {
                    alert('‚ùå Erro ao salvar na nuvem: ' + resultado.message);
                }
            } catch (error) {
                alert('üö® Erro de conex√£o com o servidor: ' + error.message);
            } finally {
                document.getElementById('addCompraButton').disabled = false;
                document.getElementById('addCompraButton').textContent = 'Adicionar Compra';
            }
        };


        // ------------------ Renderiza√ß√£o, Filtro e Exporta√ß√£o (MODIFICADAS/ADAPTADAS) ------------------
        
        const renderCompras = (comprasParaRenderizar = compras) => {
            listaCompras.innerHTML = '';
            let total = 0;
            
            // ATEN√á√ÉO: Os dados do Sheets chegam como strings. O 'preco' precisa ser convertido.
            comprasParaRenderizar.sort((a, b) => new Date(b.data) - new Date(a.data));

            comprasParaRenderizar.forEach((compra) => {
                const precoFloat = parseFloat(compra.preco); // CONVERS√ÉO
                total += precoFloat;
                const li = document.createElement('li');
                li.innerHTML = `
                    **${compra.produto}** (${compra.gtin || 'Sem GTIN'}) | R$ ${precoFloat.toFixed(2)} | ${compra.local} | ${compra.data}
                    <button onclick="removerCompra('${compra.data}', '${compra.gtin}', ${precoFloat})">Remover</button>
                `;
                listaCompras.appendChild(li);
            });

            totalGastoSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        };
        
        window.removerCompra = (data, gtin, preco) => {
            // AVISO ATUALIZADO: Remo√ß√£o na nuvem √© complexa, faremos depois.
            alert("‚ö†Ô∏è A remo√ß√£o de dados da planilha Google (nuvem) √© um processo complexo com o Apps Script e n√£o foi implementada ainda. Este registro s√≥ ser√° removido na pr√≥xima atualiza√ß√£o de c√≥digo.");
            // N√£o remove nada, apenas avisa.
        };

        const aplicarFiltro = () => {
             // ... [Mantenha o c√≥digo da fun√ß√£o aplicarFiltro] ...
            const startDate = startDateFilter.value;
            const endDate = endDateFilter.value;

            if (!startDate && !endDate) {
                renderCompras(compras); 
                return;
            }

            const dataInicial = startDate ? new Date(startDate + 'T00:00:00') : new Date('1900-01-01T00:00:00');
            const dataFinal = endDate ? new Date(endDate + 'T23:59:59') : new Date('2900-01-01T23:59:59');

            const comprasFiltradas = compras.filter(compra => {
                // A data pode vir do Sheets como objeto Date do JS, ou string. Convertemos para seguran√ßa:
                const dataCompra = new Date(compra.data.toString().slice(0, 10) + 'T00:00:00');
                return dataCompra >= dataInicial && dataCompra <= dataFinal;
            });

            renderCompras(comprasFiltradas);
        };

        filterButton.addEventListener('click', aplicarFiltro);
        
        resetFilterButton.addEventListener('click', () => {
            startDateFilter.value = '';
            endDateFilter.value = '';
            aplicarFiltro();
        });

        const exportarCSV = () => {
             // ... [Mantenha o c√≥digo da fun√ß√£o exportarCSV] ...
             if (compras.length === 0) {
                alert("N√£o h√° dados de compra para exportar.");
                return;
            }

            // Os headers precisam corresponder aos campos (data, produto, gtin, preco, local)
            const headers = ["Data", "Produto", "GTIN", "Preco", "Local"];
            let csvContent = headers.join(";") + "\n";

            compras.forEach(compra => {
                const precoFormatado = parseFloat(compra.preco).toFixed(2).replace('.', ','); 
                const row = [
                    compra.data.toString().slice(0, 10), // Limpa a data para o formato yyyy-mm-dd
                    compra.produto,
                    compra.gtin,
                    precoFormatado,
                    compra.local
                ].join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'compras_mensais_export_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Dados exportados com sucesso! Verifique sua pasta de downloads.");
        };

        exportButton.addEventListener('click', exportarCSV);

        // ------------------ Fun√ß√µes do Leitor de C√≥digo de Barras (MANTIDAS) ------------------
        
        // ... (as fun√ß√µes do scanner onScanSuccess, startScanner, e os Eventos do Modal permanecem os mesmos) ...

        const onScanSuccess = (decodedText, decodedResult) => {
            html5QrcodeScanner.stop().then(() => {
                barcodeModal.style.display = "none";
                
                gtinInput.value = decodedText;
                document.getElementById('scanResult').textContent = `C√≥digo escaneado: ${decodedText}`;

                // Simula√ß√£o da busca de produto
                const produtoSimulado = mockCatalog[decodedText];
                if (produtoSimulado) {
                    produtoInput.value = produtoSimulado.nome;
                    precoInput.value = produtoSimulado.preco;
                    localSelect.value = produtoSimulado.local;
                } else {
                    produtoInput.value = ''; 
                    precoInput.value = '';
                    localSelect.value = LOCAIS_DE_COMPRA[0]; 
                }

                alert(`C√≥digo de Barras Escaneado: ${decodedText}. Preencha os detalhes e adicione a compra.`);

            }).catch(err => {
                console.error("Erro ao parar o scanner:", err);
            });
        };
        
        const startScanner = () => {
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } }, 
                onScanSuccess, 
                (errorMessage) => { 
                    // Log de erro silencioso
                }
            ).catch(err => {
                document.getElementById('scanResult').textContent = `Erro ao iniciar a c√¢mera: ${err}. Certifique-se de que o dispositivo tem c√¢mera e deu permiss√£o.`;
            });
        };

        scanButton.onclick = function() {
            barcodeModal.style.display = "block";
            document.getElementById('scanResult').textContent = 'Aponte a c√¢mera para o c√≥digo de barras...';
            startScanner();
        }

        closeSpan.onclick = function() {
            barcodeModal.style.display = "none";
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().catch(err => console.error("Erro ao parar o scanner no fechamento:", err));
            }
        }

        window.onclick = function(event) {
            if (event.target == barcodeModal) {
                barcodeModal.style.display = "none";
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.stop().catch(err => console.error("Erro ao parar o scanner no clique externo:", err));
                }
            }
        }
        
        // ------------------ Inicializa√ß√£o ------------------
        dataCompraInput.valueAsDate = new Date();
        // Chama a fun√ß√£o de busca na nuvem para carregar o hist√≥rico
        buscarDadosDaNuvem(); 
    });
</script>

</body>

</html>


